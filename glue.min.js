var Glue=function(b){this.target=b;this.resetListeners=function(){this.listeners={any:[],assigned:{},computed:{},oldValues:{}}};this.resetListeners();this.get=function(){key=_.map(Array.prototype.slice.call(arguments),function(b){return b.replace(/\#/,".")}).join(".").replace(/\s/g,"");key=_.isArray(this.target)?0<key.length?"this.target"+key:"this.target":0<key.length?"this.target."+key:"this.target";return eval(key)};this.notify=function(b,e){function f(c){_.isEmpty(c)||(_.each(d.listeners.any,
function(c){c.func.call(c.target,e)}),_.each(d.listeners.computed,function(c,b){var f=d.get(b),g=d.listeners.oldValues[b];if(f!==g)d.listeners.oldValues[b]=f,e.oldValue=g,e.newValue=f,_.each(c,function(c){c.func.call(c.target,e)})}),_.each(d.listeners.assigned[c.join(".")],function(c){c.func.call(c.target,e)}),c.pop(),f(c))}var d=this;_.isEqual(e.oldValue,e.newValue)||_.each(b.replace(/\s/g,"").split(","),function(c){f(c.split("."))});return this}};Glue.version="0.4.1";
Glue.normalizeKey=function(b){return b.replace(/\#/g,".").replace(/\s/g,"")};Glue.prototype.bindTo=function(b){this.notify("target",{operation:"target",oldValue:this.target,newValue:this.target=b});return this};
Glue.prototype.addListener=function(){function b(b,d,c){_.each(b.split(","),function(b){"*"===b?e.listeners.any.push({target:c,func:d}):b.match(/\#/)?(b=Glue.normalizeKey(b).replace(/\]/g,""),e.listeners.oldValues[b]=e.get(b),g("computed",b,d,c)):(b=Glue.normalizeKey(b),g("assigned",b,d,c))})}function g(b,d,c,g){e.listeners[b][d]=e.listeners[b][d]||[];e.listeners[b][d].push({target:g,func:c})}var e=this;a=arguments;1===a.length?b("*",a[0],e.target):2===a.length?_.isString(a[0])?b(a[0],a[1],e.target):
b("*",a[1],a[0]):b(a[0],a[2],a[1]);return this};
Glue.prototype.removeListener=function(){function b(b,f){b?_.each(b.replace(/\s/g,"").split(","),function(b){g(b,f)}):g(b,f)}function g(b,d){"*"===b||void 0===b?d?(f.listeners.any=_.reject(f.listeners.any,function(b){return b.target===d}),_.each(f.listeners.computed,function(b,c){e("computed",c,d);_.isEmpty(f.listeners.computed[c])&&delete f.listeners.oldValues[c]}),_.each(f.listeners.assigned,function(b,c){e("assigned",c,d)})):f.resetListeners():d?b.match(/\#/)?(b=b.replace(/\#/g,"."),e("computed",
b,d)):e("assigned",b,d):b.match(/\#/)?delete f.listeners.computed[b.replace(/\#/g,".")]:delete f.listeners.assigned[b]}function e(b,d,e){f.listeners[b][d]=_.reject(f.listeners[b][d],function(b){return b.target===e})}var f=this,d=arguments;0===d.length?b("*"):1===d.length?_.isString(d[0])?b(d[0]):b(void 0,d[0]):2===d.length&&b(d[0],d[1]);return this};
Glue.prototype.set=function(b,g){var e=this;_.each(b.split(","),function(b){var d=b.lastIndexOf("."),c=b.lastIndexOf("["),c=c>d?c:d,d=Glue.normalizeKey(b.substring(c+1).replace(/\]/g,"")),c=e.get(b.substring(0,c));e.notify(b,{operation:"set",oldValue:c[d],newValue:c[d]=g})});return this};
Glue.prototype.remove=function(b){var g=this.get(b),e=b.match(/\[(\d+)\]$/);if(e){var f=e[1],e=b.lastIndexOf(e[0]);0===e?this.target.splice(f,1):this.get(b.substr(0,e)).splice(f,1)}else b=b.split("."),1<b.length?(f=b.pop(),delete this.get(b.join("."))[f]):delete this.target[b[0]],b=b.join(".");this.notify(b,{operation:"remove",oldValue:g});return this};
Glue.prototype.push=function(){function b(b,d){_.each(b.split(","),function(b){b=Glue.normalizeKey(b);g(b,e.get(b),d)})}function g(b,d,c){d.push(c);e.notify(b,{operation:"push",newValue:c})}var e=this;a=arguments;1===a.length?g("target",this.target,a[0]):b(a[0],a[1]);return this};Glue.prototype.pop=function(){var b,g;0===arguments.length?(g="this.target",b=this.target.pop()):(g=arguments[0],b=this.get(g).pop());this.notify(g,{operation:"pop",oldValue:b});return b};
Glue.prototype.filter=function(){function b(b,c){c?(_.each(g.get(c),function(f,g){b(f)||e.push([c+"["+g+"]",g,f])}),_.each(_.map(e,function(b){return b[1]}).reverse(),function(b){g.get(c).splice(b,1)}),e.push([c,"*",g.get(c)])):(_.each(g.target,function(c,f){b(c)||e.push(["["+f+"]",f,c])}),g.target=_.filter(g.target,b));_.each(e,function(b){g.notify(b[0],{operation:"remove",oldValue:b[2]})});return c?g.get(c):g.target}var g=this,e=[],f=arguments;return 1===f.length?b(f[0]):2===f.length?_.isString(f[0])?
b(f[1],f[0]):b(f[0]):b(f[1],f[0])};

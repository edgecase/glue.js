var Glue=function(a,c){this.settings=_.defaults({hasFunc:!1},c);this.target=Glue.deepClone(a,this.settings.hasFunc);this.cache=Glue.deepClone(a,this.settings.hasFunc);this.resetListeners()};Glue.version="0.5.2";Glue.prototype.hasFunc=function(a){this.settings.hasFunc=a;return this};Glue.prototype.resetListeners=function(){this.listeners={specific:{},generic:{}}};
Glue.deepClone=function(a,c){if(!c)return JSON.parse(JSON.stringify(a));var b;_.isArray(a)?b=_.map(a,function(a){return Glue.deepClone(a,!0)}):"object"===typeof a?(b={},_.each(a,function(a,c){b[c]=Glue.deepClone(a,!0)})):b=a;return b};Glue.normalizeKey=function(a){return a.replace(/\s/g,"")};Glue.permutateKey=function(a){var c=[],b=/\d*(?=\]$)/,d=a.split(".");_.each(d,function(a,f){var g=_.first(d,f+1).join(".");g.match(b)&&c.push([g,g.replace(b,""),parseInt(g.match(b)[0])])});return c.reverse()};
Glue.keysAndOperations=function(a){if(0===arguments.length)return[[],[]];var c=Glue.normalizeKey(a).split(":"),b=_.isEmpty(c[0])?[""]:c[0].split(","),c=_.isEmpty(c[1])?[]:c[1].split(",");return[b,c]};
Glue.prototype.addListener=function(){function a(a,b,f){var a=Glue.keysAndOperations(a),g=_.isEqual(a[0],[""])?["*"]:a[0],h=a[1];_.each(g,function(a){var g=a.match(/\[\]$/)?"generic":"specific";c.listeners[g][a]=c.listeners[g][a]||[];c.listeners[g][a].push({callback:b,operations:h,context:f})})}var c=this,b=arguments;1===b.length?a("*",b[0],this.target):2===b.length?_.isString(b[0])?a(b[0],b[1],this.target):a("*",b[1],b[0]):a(b[0],b[2],b[1])};
Glue.prototype.removeListener=function(){function a(a,b){var f=Glue.keysAndOperations(a),g=f[1],f=_.isEqual(f[0],[""])?_.union(_.keys(c.listeners.specific),_.keys(c.listeners.generic)):f[0];_.each(f,function(a){var f=a.match(/\[\]$/)?"generic":"specific";_.isEmpty(g)||_.each(c.listeners[f][a],function(a){a.operations=_.difference(a.operations,g)});c.listeners[f][a]=_.reject(c.listeners[f][a],function(a){return!_.isEmpty(g)&&b?_.isEmpty(a.operations)&&a.context===b:b?a.context===b:_.isEmpty(g)?!0:
_.isEmpty(a.operations)});_.isEmpty(c.listeners[f][a])&&delete c.listeners[f][a]})}var c=this,b=arguments;0===b.length?a(""):1===b.length?_.isString(b[0])?a(Glue.normalizeKey(b[0])):a("",b[0]):2===b.length&&a(Glue.normalizeKey(b[0]),b[1])};
Glue.prototype.notify=function(a,c,b){function d(a,b,c,e,d){_.isEqual(c,e)||(c={operation:a,value:e},_.isUndefined(d)||(c.index=d),_.isEmpty(b.operations)?b.callback.call(b.context,c):_.include(b.operations,a)&&b.callback.call(b.context,c))}var e=this;_.each(this.listeners.specific,function(b,c){var h=e.get(c),i=e.get(c,e.cache);_.each(b,function(b){d(a,b,i,h)})});(function(a,g,h,i){a=Glue.permutateKey(a);_.each(a,function(a){var b=a[0],c=a[2];_.each(e.listeners.generic[a[1]],function(a){d(g,a,e.get(b,
h),e.get(b,i),c)})});var l={};_.each(e.listeners.generic,function(a,b){b.match(RegExp("^"+c.replace("[","\\[").replace("]","\\]")))&&(l[b]=a)});_.each(l,function(a,c){var f=c.replace(/\[[^\[]*\]$/,""),j=e.get(f,h),k=e.get(f,i),f=j.length>k.length?j.length:k.length,f=b&&b.reverse?_.range(0,f).reverse():_.range(0,f);_.each(f,function(b){var c=j[b],e=k[b];_.each(a,function(a){d(g,a,c,e,b)})})})})(c,a,e.cache,e.target)};
Glue.prototype.get=function(a,c){if(_.isEmpty(a)||"*"===a)return c||this.target;var b=c||this.target,a=Glue.normalizeKey(a),a=(_.isArray(b)?"target":"target.")+a;return eval(a)};Glue.prototype.set=function(a,c){var b=a.lastIndexOf("."),d=a.lastIndexOf("["),e=d>b?d:b,b=a.substring(e+1).replace(/\]/g,""),d=this.get(a.substring(0,e)),e=this.get(a.substring(0,e),this.cache);d[b]=c;this.notify("set",a);e[b]=Glue.deepClone(c,this.settings.hasFunc);return this};
Glue.prototype.remove=function(a){var c,b=a.match(/\[(\d+)\]$/);b?(c=b[1],b=a.lastIndexOf(b[0]),c=0===b?this.target.splice(c,1)[0]:this.get(a.substr(0,b)).splice(c,1)[0]):(a=a.split("."),1<a.length?(b=a.pop(),c=this.get(a.join("."))[b],delete this.get(a.join("."))[b]):(c=this.target[a[0]],delete this.target[a[0]]),a=a.join("."));this.notify("remove",a);this.cache=Glue.deepClone(this.target);return c};
Glue.prototype.push=function(){var a=arguments;if(1===a.length)this.target.push(a[0]),this.notify("push","");else{var c=a[0];this.get(a[0]).push(a[1]);this.notify("push",c)}this.cache=Glue.deepClone(this.target);return this};Glue.prototype.pop=function(a){var a=a||"",c=this.get(a).pop();this.notify("pop",a);this.cache=Glue.deepClone(this.target);return c};
Glue.prototype.insert=function(){var a=0,c=arguments,b=3>c.length?"":c[a++],d=c[a++],a=c[a++];this.get(b).splice(d,0,a);this.notify("insert",b);this.cache=Glue.deepClone(this.target);return this};
Glue.prototype.filter=function(){var a=this,c=0,b=arguments,d=2>b.length?"":b[c++],e=b[c++],c=""===d?this.target:a.get(d),c=_.without(_.map(c,function(a,b){if(!e(a))return b}),void 0).reverse();_.each(c,function(b){a.get(d).splice(b,1)[0]});a.notify("filter",Glue.baseKey(d),{reverse:!0});this.cache=Glue.deepClone(this.target);return this.get(Glue.baseKey(d))};Glue.baseKey=function(a){return a.replace(/\[[^\[]*\]$/,"")};
Glue.prototype.baseKeyAndSuffix=function(a){var c=a.lastIndexOf("."),b=a.lastIndexOf("["),c=b>c?b:c,b=a.substring(c+1).replace(/\]/g,"");return[this.get(a.substring(0,c)),b]};
Glue.prototype.sortBy=function(){var a=0,c=arguments,b=2>c.length?"":c[a++],d=c[a++];collectionWithIndex=_.map(this.get(b),function(a,b){return[a,b]});a=_.sortBy(collectionWithIndex,function(a){return d(a[0])});c=_.map(a,function(a){return a[0]});""===b?this.target=c:(bs=this.baseKeyAndSuffix(b),bs[0][bs[1]]=c);_.map(a,function(a){return a[1]});this.notify("filter",Glue.baseKey(b),{reverse:!0});this.cache=Glue.deepClone(this.target);return c};
Glue.prototype.swap=function(a,c){var b=this,d=this.get(a),e=this.get(c),f=this.baseKeyAndSuffix(a),g=this.baseKeyAndSuffix(c);f[0][f[1]]=e;g[0][g[1]]=d;_.each(_.uniq(_.union(Glue.baseKey(a),Glue.baseKey(c))),function(a){b.notify("swap",a)});this.cache=Glue.deepClone(this.target);return this};

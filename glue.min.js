var Glue=function(a){this._keys=void 0;this.target=a;this.resetListeners=function(){this.listeners={any:[],assigned:{},computed:{}}};this.resetListeners()};Glue.version="0.4.5";Glue.events={};
Glue.prototype.addListener=function(){function a(a,b,h){var a=a.replace(/\s/g,"").split(":"),i=a[1];_.each((a[0]||"*").split(","),function(a){var c={listener:b};if(i)c.operations=i.split(",");if(h)c.context=h;if("*"===a)d.listeners.any.push(c);else{var f="assigned";if(a.match(/\#/))f="computed",c.oldValue=d.get(a);d.listeners[f][a]=d.listeners[f][a]||[];d.listeners[f][a].push(c)}})}var d=this,b=arguments;1===b.length?a("*",b[0],this.target):2===b.length?_.isString(b[0])?a(b[0],b[1],this.target):a("*",
b[1],b[0]):a(b[0],b[2],b[1])};
Glue.prototype.removeListener=function(){function a(a,b){var a=a.replace(/\s/g,"").split(":"),c=a[0],j=a[1];c?_.each(c.replace(/\s/g,"").split(","),function(a){d(a,j,b)}):d(c,j,b)}function d(a,c,d){function j(a,b){_.isEmpty(a[b])&&delete a[b]}function k(a){return a=_.reject(a,function(a){var b=!_.isEmpty(c);if(b&&d){if(!_.isEmpty(a.operations))return a.operations=_.difference(a.operations,c),_.isEmpty(a.operations)&&a.context===d}else{if(d)return a.context===d;if(b){if(!_.isEmpty(a.operations))return a.operations=_.difference(a.operations,
c),_.isEmpty(a.operations)}else return!0}})}c&&(c=c.split(","));if("*"===a)b.listeners.any=k(b.listeners.any),_(["assigned","computed"]).each(function(a){_.each(b.listeners[a],function(c,d){b.listeners[a][d]=k(c);j(b.listeners[a],d)})});else{var f=a&&a.match(/\#/)?"computed":"assigned";b.listeners[f][a]=k(b.listeners[f][a]);j(b.listeners[f],a)}}var b=this,c=arguments;0===c.length?a("*"):1===c.length?_.isString(c[0])?a(c[0]):a("*",c[0]):2===c.length&&a(c[0],c[1])};
Glue.prototype.notify=function(a,d,b,c){function e(a){k(a[0]).match(/\]$/)?h(a):i(a[0])}function h(c){var g;_.each(c,function(c){var e={operation:a};g=k(c);_(["old","current"]).each(function(a){c[a]&&(e[a+"Value"]=l.get(c[a],"old"===a?d:b),e[a+"Index"]=parseInt(c[a].match(/\[(\d*)]$/)[1]))});j(g,e);j(g.replace(/\d*(?=\]$)/,""),e)});g=k(c[0]).replace(/\[[^\[]*\]$/,"");e([{old:g,current:g}])}function i(c){var g=k(c),i={operation:a};_(["old","current"]).each(function(a){c[a]&&(i[a+"Value"]=l.get(c[a],
"old"===a?d:b))});j(g,i);(g=_.initial(g.split(".")).join("."))&&e([{old:g,current:g}])}function j(b,c){_.each(l.listeners.assigned[b],function(b){a&&b.operations?_.include(b.operations,a)&&f(b,c):f(b,c)})}function k(a){return a.old?a.old:a.current}function f(a,b){(b.oldValue!==b.currentValue||b.oldIndex!==b.currentIndex)&&a.listener.call(a.context,b)}var l=this;e(c);(function(){var c={operation:a,oldValue:d,currentValue:b};_.each(l.listeners.any,function(a){f(a,c)})})();(function(){var c={operation:a};
_.each(l.listeners.computed,function(a,e){c.oldValue=l.get(e,d);c.currentValue=l.get(e,b);_.each(a,function(a){f(a,c)})})})()};Glue.prototype.push=function(){function a(a,b,h){var i=Glue.deepClone(d.target);b.push(h);b=Glue.deepClone(d.target);d.notify("push",i,b,[{current:a+"["+(d.get(a).length-1)+"]"}])}var d=this,b=arguments;1===b.length?a("",this.target,b[0]):a(b[0],d.get(b[0]),b[1]);return this};
Glue.prototype.pop=function(a){var a=a||"",d=this.get(a),b=Glue.deepClone(this.target),c=d.pop(),e=Glue.deepClone(this.target);this.notify("pop",b,e,[{old:a+"["+d.length+1+"]"}]);return c};
Glue.prototype.insert=function(){var a=0,d=arguments,b=3>d.length?"":d[a++],c=d[a++],e=d[a++],a=this.get(b),d=Glue.deepClone(this.target);a.splice(c,0,e);var e=Glue.deepClone(this.target),h=[{current:b+"["+c+"]"}];_.each(_.range(c+1,a.length),function(a){h.push({old:b+"["+(a-1)+"]",current:b+"["+a+"]"})});this.notify("insert",d,e,h);return this};
Glue.prototype.filter=function(){var a=this,d=0,b=arguments,c,e=2>b.length?"":b[d++],h=b[d++],b=""===e?this.target:a.get(e),d=Glue.deepClone(this.target);c=_.without(_.map(b,function(a,b){if(!h(a))return b}),void 0).reverse();_.each(c,function(b){a.get(e).splice(b,1)});b=Glue.deepClone(this.target);c=_.map(c,function(a){return{old:e+"["+a+"]"}});this.notify("filter",d,b,c)};Glue.deepClone=function(a){return _.isArray(a)?jQuery.extend(!0,[],a):jQuery.extend(!0,{},a)};
Glue.prototype.set=function(a,d){var b=a.lastIndexOf("."),c=a.lastIndexOf("["),c=c>b?c:b,b=a.substring(c+1).replace(/\]/g,""),e=this.get(a.substring(0,c)),c=Glue.deepClone(this.target);e[b]=d;b=Glue.deepClone(this.target);this.notify("set",c,b,[{old:a,current:a}]);return this};Glue.prototype.get=function(a,d){if(""===a)return this.target;var b=d||this.target,a=a.replace(/\s/g,"").replace("#","."),a=(_.isArray(b)?"target":"target.")+a;return eval(a)};
Glue.prototype.remove=function(a){var d=Glue.deepClone(this.target);if(match=a.match(/\[(\d+)\]$/)){var b=match[1],c=a.lastIndexOf(match[0]);0===c?this.target.splice(b,1):this.get(a.substr(0,c)).splice(b,1)}else a=a.split("."),1<a.length?(b=a.pop(),delete this.get(a.join("."))[b]):delete this.target[a[0]],a=a.join(".");this.notify("remove",d,Glue.deepClone(this.target),[{old:a}]);return this};

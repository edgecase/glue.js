var Glue=function(a){this.target=a;this.resetListeners();this.objID=Glue.nextObjectID()};Glue.version="0.6.0-alpha";Glue._objID=0;Glue.nextObjectID=function(){return++Glue._objID};Glue.events={};Glue.prototype.addListener=function(a,c){_.defaults([],Glue.events[a]);Glue.events[a].push({objID:this.objID,callback:c})};Glue.prototype.removeListener=function(a){Glue.events[a]=_.filter(Glue.events[a],function(a){var b=!1;return b=a.objID===this.objID})};
Glue.prototype.emit=function(a){_.each(Glue.events[a],function(a){a.callback(_.rest(_.toArray(arguments)))})};Glue.prototype.resetListeners=function(){this.listeners={specific:{},generic:{}}};Glue.deepClone=function(a){return JSON.parse(JSON.stringify(a))};Glue.normalizeKey=function(a){return a.replace(/\s/g,"")};
Glue.permutateKey=function(a){var c=[],b=a.split(".");_.each(b,function(a,f){var e=_.first(b,f+1).join("."),g=/\d*(?=\]$)/;e.match(g)&&c.push({specific:e,generic:e.replace(g,""),index:parseInt(e.match(g)[0])})});return c};Glue.keysAndOperations=function(a){if(0===arguments.length)return[[],[]];var c=Glue.normalizeKey(a).split(":"),b=_.isEmpty(c[0])?[""]:c[0].split(","),c=_.isEmpty(c[1])?[]:c[1].split(",");return[b,c]};
Glue.prototype.addObserver=function(){function a(a,b,e){var a=Glue.keysAndOperations(a),g=_.isEqual(a[0],[""])?["*"]:a[0],h=a[1];_.each(g,function(a){var d=a.match(/\[\]$/)?"generic":"specific";c.listeners[d][a]=c.listeners[d][a]||[];c.listeners[d][a].push({callback:b,operations:h,context:e})})}var c=this,b=arguments;1===b.length?a("*",b[0],this.target):2===b.length?_.isString(b[0])?a(b[0],b[1],this.target):a("*",b[1],b[0]):a(b[0],b[2],b[1])};
Glue.prototype.removeObserver=function(){function a(a,b){var e=Glue.keysAndOperations(a),g=e[1],e=_.isEqual(e[0],[""])?_.union(_.keys(c.listeners.specific),_.keys(c.listeners.generic)):e[0];_.each(e,function(a){var e=a.match(/\[\]$/)?"generic":"specific";_.isEmpty(g)||_.each(c.listeners[e][a],function(a){a.operations=_.difference(a.operations,g)});c.listeners[e][a]=_.reject(c.listeners[e][a],function(a){return!_.isEmpty(g)&&b?_.isEmpty(a.operations)&&a.context===b:b?a.context===b:_.isEmpty(g)?!0:
_.isEmpty(a.operations)});_.isEmpty(c.listeners[e][a])&&delete c.listeners[e][a]})}var c=this,b=arguments;0===b.length?a(""):1===b.length?_.isString(b[0])?a(Glue.normalizeKey(b[0])):a("",b[0]):2===b.length&&a(Glue.normalizeKey(b[0]),b[1])};
Glue.prototype.notify=function(a,c,b,d){function f(a,b,c,e,d,f){_.isEqual(d,e)||(c={operation:a,value:c},_.isUndefined(f)||(c.index=f),_.isEmpty(b.operations)?b.callback.call(b.context,c):_.include(b.operations,a)&&b.callback.call(b.context,c))}var e=this,g=Glue.deepClone(this.target);_.each(this.listeners.specific,function(c,d){var j=e.get(d),m=e.get(d,g),n=e.get(d,b);_.each(c,function(b){f(a,b,j,m,n)})});(function(){var h=Glue.permutateKey(c);_.each(h,function(c){_.each(e.listeners.generic[c.generic],
function(d){var i=e.get(c.specific),h=e.get(c.specific,g),k=e.get(c.specific,b);f(a,d,i,h,k,c.index)})});var l={},j=RegExp("^"+c.replace("[","\\[").replace("]","\\]"));_.each(e.listeners.generic,function(a,b){b.match(j)&&(l[b]=a)});_.each(l,function(c,h){var i=h.replace(/\[[^\[]*\]$/,""),l=e.get(i),k=e.get(i,g),j=e.get(i,b),i=j.length>k.length?j.length:k.length,i=d?_.range(0,i).reverse():_.range(0,i);_.each(i,function(b){var e=l[b],d=k[b],g=j[b];_.each(c,function(c){f(a,c,e,d,g,b)})})})})()};
Glue.prototype.get=function(a,c){if(""===a||"*"===a)return c||this.target;var b,d=c||this.target,a=Glue.normalizeKey(a),a=(_.isArray(d)?"target":"target.")+a;try{b=eval(a)}catch(f){b=void 0}return b};Glue.prototype.set=function(a,c){var b=Glue.deepClone(this.target),d=a.lastIndexOf("."),f=a.lastIndexOf("["),d=f>d?f:d,f=a.substring(d+1).replace(/\]/g,"");this.get(a.substring(0,d))[f]=c;this.notify("set",a,b);return this};
Glue.prototype.remove=function(a){var c=Glue.deepClone(this.target);if(match=a.match(/\[(\d+)\]$/)){var b=match[1],d=a.lastIndexOf(match[0]);removed=0===d?this.target.splice(b,1)[0]:this.get(a.substr(0,d)).splice(b,1)[0]}else a=a.split("."),1<a.length?(b=a.pop(),removed=this.get(a.join("."))[b],delete this.get(a.join("."))[b]):(removed=this.target[a[0]],delete this.target[a[0]]),a=a.join(".");this.notify("remove",a,c);return removed};
Glue.prototype.push=function(){var a=Glue.deepClone(this.target),c=arguments;if(1===c.length)this.target.push(c[0]),this.notify("push","",a);else{var b=c[0];this.get(c[0]).push(c[1]);this.notify("push",b,a)}return this};Glue.prototype.pop=function(a){var c=Glue.deepClone(this.target),a=a||"",b=this.get(a).pop();this.notify("pop",a,c);return b};
Glue.prototype.insert=function(){var a=Glue.deepClone(this.target),c=c||"",b=0,d=arguments,c=3>d.length?"":d[b++],f=d[b++],b=d[b++];this.get(c).splice(f,0,b);this.notify("insert",c,a);return this};Glue.prototype.filter=function(){var a=Glue.deepClone(this.target),c=this,b=0,d=arguments,f=2>d.length?"":d[b++],e=d[b++],b=""===f?this.target:c.get(f),b=_.without(_.map(b,function(a,b){if(!e(a))return b}),void 0).reverse();_.each(b,function(a){c.get(f).splice(a,1)[0]});c.notify("filter",f,a,!0);return this.get(Glue.baseKey(f))};
Glue.baseKey=function(a){return a.replace(/\[[^\[]*\]$/,"")};Glue.prototype.baseKeyAndSuffix=function(a){var c=a.lastIndexOf("."),b=a.lastIndexOf("["),c=b>c?b:c,b=a.substring(c+1).replace(/\]/g,"");return[this.get(a.substring(0,c)),b]};
Glue.prototype.sortBy=function(){var a=Glue.deepClone(this.target),c=0,b=arguments,d=2>b.length?"":b[c++],f=b[c++];collectionWithIndex=_.map(this.get(d),function(a,b){return[a,b]});c=_.sortBy(collectionWithIndex,function(a){return f(a[0])});b=_.map(c,function(a){return a[0]});""===d?this.target=b:(bs=this.baseKeyAndSuffix(d),bs[0][bs[1]]=b);_.map(c,function(a){return a[1]});this.notify("filter",d,a,!0);return b};
Glue.prototype.swap=function(a,c){var b=Glue.deepClone(this.target),d=this,f=this.get(a),e=this.get(c),g=this.baseKeyAndSuffix(a),h=this.baseKeyAndSuffix(c);g[0][g[1]]=e;h[0][h[1]]=f;_.each(_.uniq(_.union(Glue.baseKey(a),Glue.baseKey(c))),function(a){d.notify("swap",a,b)});return this};

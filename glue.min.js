var Glue=function(a){this.boundObject=a;this.listeners={};this.listenersCalcOrFunc={};this.anyKeyPath="*";this.keyPathIsCalculated=function(a){return!!a.match(/\(.+\)$/)};this.keyPathIsFunctional=function(a){return!!a.match(/.+\(\)$/)};this.keyPathIsFunctionalOrCalculated=function(a){return!!a.match(/\(?.+?\(?\)/)}};Glue.version="0.3.0";
Glue.prototype.get=function(a){var b=this,c=function(a,f){var d;d=_.first(a);b.keyPathIsFunctional(d)?(d=d.replace(/\(\)/,""),d=a.length===1?f[d].apply(b.boundObject):c(_.rest(a),f[d].apply(b.boundObject))):(b.keyPathIsCalculated(d)&&(d=d.replace(/\(/,"").replace(/\)/,"")),d=a.length===1?f[d]:c(_.rest(a),f[d]));return d};return c(a.split("."),this.boundObject)};
Glue.prototype.set=function(a,b){var c=this.get(a),e=function(a,c){a.length===1?c[_.first(a)]=b:c[_.first(a)]=e(_.rest(a),c[_.first(a)]);return c};_.extend(this.boundObject,e(a.split("."),this.boundObject));this.notify(a,{oldValue:c,value:b});return this};Glue.prototype.getBoundObject=function(){return _.clone(this.boundObject)};Glue.prototype.bindTo=function(a){this.notify("boundObject",{oldValue:this.boundObject,value:this.boundObject=a});return this};
Glue.prototype.addListener=function(){var a,b,c=arguments[0];switch(arguments.length){case 1:a=arguments[0];break;case 2:_.isFunction(arguments[0])?(b=arguments[1],a=arguments[0]):a=arguments[1];break;default:b=arguments[1],a=arguments[2]}b=b||this.anyKeyPath;c={target:c,hollaback:a};this.keyPathIsFunctionalOrCalculated(b)?(a="listenersCalcOrFunc",c.oldValue=this.get(b)):a="listeners";this[a][b]=this[a][b]||[];this[a][b].push(c);return this};
Glue.prototype.removeListener=function(){var a,b,c=this,e=function(a,b,c){_.each(a,function(e,g){a[g]=_.reject(e,function(a){return a.target===b&&!_.isUndefined(c)&&c===g})});return a};arguments.length===0?(this.listeners={},this.listenersCalcOrFunc={}):arguments.length===1&&!_.isUndefined(arguments[0].keyPath)?(delete this.listeners[a],delete this.listenersCalcOrFunc[a]):(b=arguments[0],a=arguments[1],_.each(["listeners","listenersCalcOrFunc"],function(f){c.listeners=e(c[f],b,a)}));return this};
Glue.prototype.notify=function(a,b){var c=this;_.each(this.listeners[a],function(a){a.hollaback.call(a.target,b)});_.each(this.listeners[this.anyKeyPath],function(a){a.hollaback.call(a.target,b)});_.each(this.listenersCalcOrFunc,function(a,b){var d=c.get(b);_.each(a,function(a){if(!_.isEqual(d,a.oldValue))a.hollaback.call(a.target,{oldValue:a.oldValue,value:d}),a.oldValue=d})});return this};
Glue.prototype.add=function(a,b){var c=this.get(a);c.push(b);this.notify.call(this,a,{keyPath:a,collectionOperation:"add",value:b,collection:c,currentCount:this.count(a)});return this};Glue.prototype.replaceWith=function(a,b,c){var e=this.get(a),b=e.splice.call(e,c,1,b);this.notify.call(this,a,{keyPath:a,collectionOperation:"replace",value:b,collection:e,currentCount:this.count(a)});return this};
Glue.prototype.removeAt=function(a,b){var c=this.get(a),e=c.splice.call(c,b,1);this.notify.call(this,a,{keyPath:a,collectionOperation:"remove",value:e,collection:c,currentCount:this.count(a)});return this};Glue.prototype.insertAt=function(a,b,c){Array.prototype.splice.call(arguments);var e=this.get(a);e.splice.call(e,b,0,c);this.notify.call(this,a,{keyPath:a,collectionOperation:"add",value:c,collection:e,currentCount:this.count(a)});return this};Glue.prototype.objectAt=function(a,b){return this.get(a)[b]};
Glue.prototype.count=function(a){return this.get(a).length};

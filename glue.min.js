var Glue=function(a){this.target=Glue.deepClone(a);this.updateCache();this.resetListeners()};Glue.version="0.5.2";Glue.prototype.resetListeners=function(){this.listeners={specific:{},generic:{}}};Glue.deepClone=function(a){return JSON.parse(JSON.stringify(a))};Glue.prototype.updateCache=function(){this.cache=Glue.deepClone(this.target)};Glue.normalizeKey=function(a){return a.replace(/\s/g,"")};
Glue.permutateKey=function(a){var b=[],c=a.split(".");_.each(c,function(a,f){var d=_.first(c,f+1).join("."),g=/\d*(?=\]$)/;d.match(g)&&b.push([d,d.replace(g,""),parseInt(d.match(g)[0])])});return b.reverse()};Glue.keysAndOperations=function(a){if(0===arguments.length)return[[],[]];var b=Glue.normalizeKey(a).split(":"),c=_.isEmpty(b[0])?[""]:b[0].split(","),b=_.isEmpty(b[1])?[]:b[1].split(",");return[c,b]};
Glue.prototype.addListener=function(){function a(a,c,d){var a=Glue.keysAndOperations(a),g=_.isEqual(a[0],[""])?["*"]:a[0],h=a[1];_.each(g,function(a){var g=a.match(/\[\]$/)?"generic":"specific";b.listeners[g][a]=b.listeners[g][a]||[];b.listeners[g][a].push({callback:c,operations:h,context:d})})}var b=this,c=arguments;1===c.length?a("*",c[0],this.target):2===c.length?_.isString(c[0])?a(c[0],c[1],this.target):a("*",c[1],c[0]):a(c[0],c[2],c[1])};
Glue.prototype.removeListener=function(){function a(a,c){var d=Glue.keysAndOperations(a),g=d[1],d=_.isEqual(d[0],[""])?_.union(_.keys(b.listeners.specific),_.keys(b.listeners.generic)):d[0];_.each(d,function(a){var d=a.match(/\[\]$/)?"generic":"specific";_.isEmpty(g)||_.each(b.listeners[d][a],function(a){a.operations=_.difference(a.operations,g)});b.listeners[d][a]=_.reject(b.listeners[d][a],function(a){return!_.isEmpty(g)&&c?_.isEmpty(a.operations)&&a.context===c:c?a.context===c:_.isEmpty(g)?!0:
_.isEmpty(a.operations)});_.isEmpty(b.listeners[d][a])&&delete b.listeners[d][a]})}var b=this,c=arguments;0===c.length?a(""):1===c.length?_.isString(c[0])?a(Glue.normalizeKey(c[0])):a("",c[0]):2===c.length&&a(Glue.normalizeKey(c[0]),c[1])};
Glue.prototype.notify=function(a,b,c){function e(a,c,b,f,e){_.isEqual(b,f)||(b={operation:a,oldValue:b,currentValue:f},_.isUndefined(e)||(b.index=e),_.isEmpty(c.operations)?c.callback.call(c.context,b):_.include(c.operations,a)&&c.callback.call(c.context,b))}var f=this;_.each(this.listeners.specific,function(c,b){var h=f.get(b),i=f.get(b,f.cache);_.each(c,function(b){e(a,b,i,h)})});(function(a,g,h,i){a=Glue.permutateKey(a);_.each(a,function(a){var b=a[0],c=a[2];_.each(f.listeners.generic[a[1]],function(a){e(g,
a,f.get(b,h),f.get(b,i),c)})});var l={};_.each(f.listeners.generic,function(a,c){c.match(RegExp("^"+b.replace("[","\\[").replace("]","\\]")))&&(l[c]=a)});_.each(l,function(a,b){var d=b.replace(/\[[^\[]*\]$/,""),j=f.get(d,h),k=f.get(d,i),d=j.length>k.length?j.length:k.length,d=c&&c.reverse?_.range(0,d).reverse():_.range(0,d);_.each(d,function(b){var c=j[b],d=k[b];_.each(a,function(a){e(g,a,c,d,b)})})})})(b,a,f.cache,f.target)};
Glue.prototype.get=function(a,b){if(""===a||"*"===a)return b||this.target;var c=b||this.target,a=Glue.normalizeKey(a),a=(_.isArray(c)?"target":"target.")+a;return eval(a)};Glue.prototype.set=function(a,b){var c=a.lastIndexOf("."),e=a.lastIndexOf("["),c=e>c?e:c,e=a.substring(c+1).replace(/\]/g,"");this.get(a.substring(0,c))[e]=b;this.notify("set",a);this.updateCache();return this};
Glue.prototype.remove=function(a){var b,c=a.match(/\[(\d+)\]$/);c?(b=c[1],c=a.lastIndexOf(c[0]),b=0===c?this.target.splice(b,1)[0]:this.get(a.substr(0,c)).splice(b,1)[0]):(a=a.split("."),1<a.length?(c=a.pop(),b=this.get(a.join("."))[c],delete this.get(a.join("."))[c]):(b=this.target[a[0]],delete this.target[a[0]]),a=a.join("."));this.notify("remove",a);this.updateCache();return b};
Glue.prototype.push=function(){var a=arguments;if(1===a.length)this.target.push(a[0]),this.notify("push","");else{var b=a[0];this.get(a[0]).push(a[1]);this.notify("push",b)}this.updateCache();return this};Glue.prototype.pop=function(a){var a=a||"",b=this.get(a).pop();this.notify("pop",a);this.updateCache();return b};Glue.prototype.insert=function(){var a=0,b=arguments,c=3>b.length?"":b[a++],e=b[a++],a=b[a++];this.get(c).splice(e,0,a);this.notify("insert",c);this.updateCache();return this};
Glue.prototype.filter=function(){var a=this,b=0,c=arguments,e=2>c.length?"":c[b++],f=c[b++],b=""===e?this.target:a.get(e),b=_.without(_.map(b,function(a,b){if(!f(a))return b}),void 0).reverse();_.each(b,function(b){a.get(e).splice(b,1)[0]});a.notify("filter",Glue.baseKey(e),{reverse:!0});this.updateCache();return this.get(Glue.baseKey(e))};Glue.baseKey=function(a){return a.replace(/\[[^\[]*\]$/,"")};
Glue.prototype.baseKeyAndSuffix=function(a){var b=a.lastIndexOf("."),c=a.lastIndexOf("["),b=c>b?c:b,c=a.substring(b+1).replace(/\]/g,"");return[this.get(a.substring(0,b)),c]};
Glue.prototype.sortBy=function(){var a=0,b=arguments,c=2>b.length?"":b[a++],e=b[a++];collectionWithIndex=_.map(this.get(c),function(a,b){return[a,b]});a=_.sortBy(collectionWithIndex,function(a){return e(a[0])});b=_.map(a,function(a){return a[0]});""===c?this.target=b:(bs=this.baseKeyAndSuffix(c),bs[0][bs[1]]=b);_.map(a,function(a){return a[1]});this.notify("filter",Glue.baseKey(c),{reverse:!0});this.updateCache();return b};
Glue.prototype.swap=function(a,b){var c=this,e=this.get(a),f=this.get(b),d=this.baseKeyAndSuffix(a),g=this.baseKeyAndSuffix(b);d[0][d[1]]=f;g[0][g[1]]=e;_.each(_.uniq(_.union(Glue.baseKey(a),Glue.baseKey(b))),function(a){c.notify("swap",a)});return this};

var Glue=function(b){this.target=b;this.resetListeners=function(){this.listeners={any:[],assigned:{},computed:{},oldValues:{}}};this.resetListeners();this.get=function(){key=_.map(Array.prototype.slice.call(arguments),function(b){return b.replace(/\#/,".")}).join(".").replace(/\s/g,"");key=_.isArray(this.target)?0<key.length?"this.target"+key:"this.target":0<key.length?"this.target."+key:"this.target";return eval(key)};this.notify=function(b,c){function g(d){_.isEmpty(d)||(_.each(e.listeners.any,
function(d){d.func.call(d.target,c)}),_.each(e.listeners.computed,function(d,b){var g=e.get(b),f=e.listeners.oldValues[b];if(g!==f)e.listeners.oldValues[b]=g,c.oldValue=f,c.newValue=g,_.each(d,function(d){d.func.call(d.target,c)})}),_.each(e.listeners.assigned[d.join(".")],function(d){d.func.call(d.target,c)}),d.pop(),g(d))}var e=this;_.isEqual(c.oldValue,c.newValue)||_.each(b.replace(/\s/g,"").split(","),function(d){g(d.split("."))});return this}};Glue.version="0.4.0";
Glue.normalizeKey=function(b){return b.replace(/\#/g,".").replace(/\s/g,"")};Glue.prototype.bindTo=function(b,f){var c=this.target;this.notify("target",{operation:"target",oldValue:c,newValue:this.target=b});f&&f(c,this.target);return this};
Glue.prototype.addListener=function(){function b(b,e,d){_.each(b.split(","),function(b){"*"===b?c.listeners.any.push({target:d,func:e}):b.match(/\#/)?(b=Glue.normalizeKey(b).replace(/\]/g,""),c.listeners.oldValues[b]=c.get(b),f("computed",b,e,d)):(b=Glue.normalizeKey(b),f("assigned",b,e,d))})}function f(b,e,d,f){c.listeners[b][e]=c.listeners[b][e]||[];c.listeners[b][e].push({target:f,func:d})}var c=this;a=arguments;1===a.length?b("*",a[0],c.target):2===a.length?_.isString(a[0])?b(a[0],a[1],c.target):
b("*",a[1],a[0]):b(a[0],a[2],a[1]);return this};
Glue.prototype.removeListener=function(){function b(b,c){b?_.each(b.replace(/\s/g,"").split(","),function(b){f(b,c)}):f(b,c)}function f(b,e){"*"===b||void 0===b?e?(g.listeners.any=_.reject(g.listeners.any,function(b){return b.target===e}),_.each(g.listeners.computed,function(b,d){c("computed",d,e);_.isEmpty(g.listeners.computed[d])&&delete g.listeners.oldValues[d]}),_.each(g.listeners.assigned,function(b,d){c("assigned",d,e)})):g.resetListeners():e?b.match(/\#/)?(b=b.replace(/\#/g,"."),c("computed",
b,e)):c("assigned",b,e):b.match(/\#/)?delete g.listeners.computed[b.replace(/\#/g,".")]:delete g.listeners.assigned[b]}function c(b,e,c){g.listeners[b][e]=_.reject(g.listeners[b][e],function(b){return b.target===c})}var g=this,e=arguments;0===e.length?b("*"):1===e.length?_.isString(e[0])?b(e[0]):b(void 0,e[0]):2===e.length&&b(e[0],e[1]);return this};
Glue.prototype.set=function(b,f,c){var g=this;_.each(b.split(","),function(b){var d=b.lastIndexOf("."),c=b.lastIndexOf("["),c=c>d?c:d,d=Glue.normalizeKey(b.substring(c+1).replace(/\]/g,"")),c=g.get(b.substring(0,c));g.notify(b,{operation:"set",oldValue:c[d],newValue:c[d]=f})});c&&c(f);return this};
Glue.prototype.remove=function(b,f){var c=this.get(b),g=b.match(/\[(\d+)\]$/);if(g){var e=g[1],g=b.lastIndexOf(g[0]);0===g?this.target.splice(e,1):this.get(b.substr(0,g)).splice(e,1)}else b=b.split("."),1<b.length?(e=b.pop(),delete this.get(b.join("."))[e]):delete this.target[b[0]],b=b.join(".");this.notify(b,{operation:"remove",oldValue:c});f&&f(c);return this};
Glue.prototype.push=function(){function b(b,e){_.each(b.split(","),function(b){b=Glue.normalizeKey(b);f(b,c.get(b),e)})}function f(b,e,d,f){e.push(d);c.notify(b,{operation:"push",newValue:d});f&&f(d)}var c=this;a=arguments;1===a.length?f("target",this.target,a[0]):2===a.length&&_.isFunction(a[1])?f("target",this.target,a[0],a[1]):3===a.length?b(a[0],a[1],a[2]):b(a[0],a[1]);return this};
Glue.prototype.pop=function(){var b=arguments,f,c;0===b.length?f=this.target.pop():1===b.length?_.isString(b[0])?f=this.get(b[0]).pop():(f=this.target.pop(),c=b[0]):(f=this.get(b[0]).pop(),c=b[1]);this.notify(key,{operation:"pop",oldValue:f});c&&c(f);return f};
Glue.prototype.filter=function(){function b(b,c){c?(_.each(f.get(c),function(d,f){b(d)||e.push([c+"["+f+"]",f,d])}),_.each(_.map(e,function(b){return b[1]}).reverse(),function(b){f.get(c).splice(b,1)}),e.push([c,"*",f.get(c)])):(_.each(f.target,function(c,d){b(c)||e.push(["["+d+"]",d,c])}),f.target=_.filter(f.target,b));_.each(e,function(b){f.notify(b[0],{operation:"remove",oldValue:b[2]})});return c?this.get(c):this.target}var f=this,c,g,e=[],d=arguments;1===d.length?c=b(d[0]):2===d.length?_.isString(d[0])?
c=b(d[1],d[0]):(c=b(d[0]),g=d[1]):(c=b(d[1],d[0]),g=d[2]);g&&g(c);return c};

var Glue=function(g){this.target=g;this.resetListeners=function(){this.listeners={any:[],assigned:{},computed:{},oldValues:{}}};this.resetListeners();this.get=function(c){c=c.replace("#",".").replace(/\s/g,"");c=0<c.length?(_.isArray(this.target)?"this.target":"this.target.")+c:"this.target";return eval(c)};this.notify=function(c,d){function f(c){_.isEmpty(c)||(e(b.listeners.assigned[c.join(".")]),f(_.initial(c)))}function e(b){_.each(b,function(b){b.func.call(b.target,d)})}var b=this;_.isEqual(d.oldValue,
d.newValue)||(e(b.listeners.any),_.each(b.listeners.computed,function(c,f){var g=b.get(f),h=b.listeners.oldValues[f];if(g!==h)b.listeners.oldValues[f]=g,d.oldValue=h,d.newValue=g,e(c)}),f(c.split(".")));return this}};Glue.version="0.4.2";Glue.prototype.bindTo=function(g){this.notify("target",{operation:"target",oldValue:this.target,newValue:this.target=g});return this};
Glue.prototype.addListener=function(){function g(d,f,e){_.each(d.split(","),function(b){if("*"===b)c.listeners.any.push({target:e,func:f});else{var d="assigned",b=b.replace(/\s/g,"");b.match(/\#/)&&(d="computed",b=b.replace("#","."),c.listeners.oldValues[b]=c.get(b));c.listeners[d][b]=c.listeners[d][b]||[];c.listeners[d][b].push({target:e,func:f})}})}var c=this;a=arguments;1===a.length?g("*",a[0],c.target):2===a.length?_.isString(a[0])?g(a[0],a[1],c.target):g("*",a[1],a[0]):g(a[0],a[2],a[1]);return this};
Glue.prototype.removeListener=function(){function g(b,d){b?_.each(b.replace(/\s/g,"").split(","),function(b){c(b,d)}):c(b,d)}function c(b,c){"*"===b||void 0===b?c?(f.listeners.any=_.reject(f.listeners.any,function(b){return b.target===c}),_.each(f.listeners.computed,function(b,e){d("computed",e,c);_.isEmpty(f.listeners.computed[e])&&delete f.listeners.oldValues[e]}),_.each(f.listeners.assigned,function(b,f){d("assigned",f,c)})):f.resetListeners():c?b.match(/\#/)?(b=b.replace(/\#/g,"."),d("computed",
b,c)):d("assigned",b,c):b.match(/\#/)?delete f.listeners.computed[b.replace(/\#/g,".")]:delete f.listeners.assigned[b]}function d(b,c,d){f.listeners[b][c]=_.reject(f.listeners[b][c],function(b){return b.target===d})}var f=this,e=arguments;0===e.length?g("*"):1===e.length?_.isString(e[0])?g(e[0]):g(void 0,e[0]):2===e.length&&g(e[0],e[1]);return this};
Glue.prototype.set=function(g,c){var d=this;_.each(g.replace(/\s/g,"").split(","),function(f){var e=f.lastIndexOf("."),b=f.lastIndexOf("["),b=b>e?b:e,e=f.substring(b+1).replace("#",".").replace(/\]/g,""),b=d.get(f.substring(0,b));d.notify(f,{operation:"set",oldValue:b[e],newValue:b[e]=c})});return this};
Glue.prototype.remove=function(g){var c=this;_.each(g.replace(/\s/g,"").split(","),function(d){var f=c.get(d),e=d.match(/\[(\d+)\]$/);if(e){var b=e[1],e=d.lastIndexOf(e[0]);0===e?c.target.splice(b,1):c.get(d.substr(0,e)).splice(b,1)}else d=d.split("."),1<d.length?(b=d.pop(),delete c.get(d.join("."))[b]):delete c.target[d[0]],d=d.join(".");c.notify(d,{operation:"remove",oldValue:f})});return this};
Glue.prototype.push=function(){function g(f,e){_.each(f.split(","),function(b){b=b.replace(/\s/g,"");c(b,d.get(b),e)})}function c(c,e,b){e.push(b);d.notify(c,{operation:"push",newValue:b})}var d=this;a=arguments;1===a.length?c("target",this.target,a[0]):g(a[0],a[1]);return this};Glue.prototype.pop=function(){var g=this,c,d=arguments;keys=0===d.length?"":d[0];_.each(keys.replace(/\s/g,"").split(","),function(d){c=g.get(d).pop();g.notify(d,{operation:"pop",oldValue:c})});return c};
Glue.prototype.filter=function(){function g(b,d){d?(_.each(c.get(d),function(c,e){b(c)||f.push([d+"["+e+"]",e,c])}),_.each(_.map(f,function(b){return b[1]}).reverse(),function(b){c.get(d).splice(b,1)}),f.push([d,"*",c.get(d)])):(_.each(c.target,function(c,d){b(c)||f.push(["["+d+"]",d,c])}),c.target=_.filter(c.target,b));_.each(f,function(b){c.notify(b[0],{operation:"remove",oldValue:b[2]})});return d?c.get(d):c.target}var c=this,d,f=[],e=arguments;1===e.length?d=g(e[0]):2===e.length&&(d=g(e[1],e[0]));
return d};

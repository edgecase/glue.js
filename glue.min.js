var Glue=function(g){this.target=g;this.resetListeners=function(){this.listeners={any:[],assigned:{},computed:{},oldValues:{}}};this.resetListeners()};Glue.version="0.4.3";Glue.prototype.bindTo=function(g){this.notify("target",{operation:"target",oldValue:this.target,newValue:this.target=g});return this};
Glue.prototype.notify=function(g,d){function c(b){if(!_.isEmpty(b)){var h=b.join(".");f(e.listeners.assigned[h],d,"assigned",h);c(_.initial(b))}}function f(b,h,d,c){_.each(b,function(b){b.func.call(b.target,h)});c&&c.match(/\]$/)&&(b=parseInt(c.match(/\[(\d*)]$/)[1]),c=c.replace(/\d*(?=\]$)/,""),f(e.listeners[d][c],_.extend(_.clone(h),{index:b})))}var e=this;_.isEqual(d.oldValue,d.newValue)||(f(e.listeners.any,d),_.each(e.listeners.computed,function(b,h){var c=e.get(h),g=e.listeners.oldValues[h];
if(c!==g)e.listeners.oldValues[h]=c,d.oldValue=g,d.newValue=c,f(b,d,"computed",h)}),c(g.split(".")));return this};
Glue.prototype.addListener=function(){function g(c,f,e){_.each(c.split(","),function(b){if("*"===b)d.listeners.any.push({target:e,func:f});else{var c="assigned",b=b.replace(/\s/g,"");b.match(/\#/)&&(c="computed",b=b.replace("#","."),d.listeners.oldValues[b]=d.get(b));d.listeners[c][b]=d.listeners[c][b]||[];d.listeners[c][b].push({target:e,func:f})}})}var d=this;a=arguments;1===a.length?g("*",a[0],d.target):2===a.length?_.isString(a[0])?g(a[0],a[1],d.target):g("*",a[1],a[0]):g(a[0],a[2],a[1]);return this};
Glue.prototype.removeListener=function(){function g(b,c){b?_.each(b.replace(/\s/g,"").split(","),function(b){d(b,c)}):d(b,c)}function d(b,d){"*"===b||void 0===b?d?(f.listeners.any=_.reject(f.listeners.any,function(b){return b.target===d}),_.each(f.listeners.computed,function(b,e){c("computed",e,d);_.isEmpty(f.listeners.computed[e])&&delete f.listeners.oldValues[e]}),_.each(f.listeners.assigned,function(b,e){c("assigned",e,d)})):f.resetListeners():d?b.match(/\#/)?(b=b.replace(/\#/g,"."),c("computed",
b,d)):c("assigned",b,d):b.match(/\#/)?delete f.listeners.computed[b.replace(/\#/g,".")]:delete f.listeners.assigned[b]}function c(b,d,c){f.listeners[b][d]=_.reject(f.listeners[b][d],function(b){return b.target===c})}var f=this,e=arguments;0===e.length?g("*"):1===e.length?_.isString(e[0])?g(e[0]):g(void 0,e[0]):2===e.length&&g(e[0],e[1]);return this};
Glue.prototype.get=function(g){g=g.replace("#",".").replace(/\s/g,"");g=0<g.length?(_.isArray(this.target)?"this.target":"this.target.")+g:"this.target";return eval(g)};Glue.prototype.set=function(g,d){var c=this;_.each(g.replace(/\s/g,"").split(","),function(f){var e=f.lastIndexOf("."),b=f.lastIndexOf("["),b=b>e?b:e,e=f.substring(b+1).replace("#",".").replace(/\]/g,""),b=c.get(f.substring(0,b));c.notify(f,{operation:"set",oldValue:b[e],newValue:b[e]=d})});return this};
Glue.prototype.remove=function(g){var d=this;_.each(g.replace(/\s/g,"").split(","),function(c){var f=d.get(c),e=c.match(/\[(\d+)\]$/);if(e){var b=e[1],e=c.lastIndexOf(e[0]);0===e?d.target.splice(b,1):d.get(c.substr(0,e)).splice(b,1)}else c=c.split("."),1<c.length?(b=c.pop(),delete d.get(c.join("."))[b]):delete d.target[c[0]],c=c.join(".");d.notify(c,{operation:"remove",oldValue:f})});return this};
Glue.prototype.push=function(){function g(e,b){_.each(e.split(","),function(e){e=e.replace(/\s/g,"");d(e,c.get(e),b)})}function d(d,b,f){b.push(f);c.notify(d,{operation:"push",newValue:f})}var c=this,f=arguments;1===f.length?d("target",this.target,f[0]):g(f[0],f[1]);return this};Glue.prototype.pop=function(){var g=this,d,c=arguments;keys=0===c.length?"":c[0];_.each(keys.replace(/\s/g,"").split(","),function(c){d=g.get(c).pop();g.notify(c,{operation:"pop",oldValue:d})});return d};
Glue.prototype.filter=function(){function g(b,c){c?(_.each(d.get(c),function(d,e){b(d)||f.push([c+"["+e+"]",e,d])}),_.each(_.map(f,function(b){return b[1]}).reverse(),function(b){d.get(c).splice(b,1)}),f.push([c,"*",d.get(c)])):(_.each(d.target,function(c,d){b(c)||f.push(["["+d+"]",d,c])}),d.target=_.filter(d.target,b));_.each(f,function(b){d.notify(b[0],{operation:"remove",oldValue:b[2]})});return c?d.get(c):d.target}var d=this,c,f=[],e=arguments;1===e.length?c=g(e[0]):2===e.length&&(c=g(e[1],e[0]));
return c};
